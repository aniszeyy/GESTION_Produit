using System.Data;
using System.Data.SqlClient;

namespace AccesBDD
{
    public partial class miseAJourProd : Form
    {
        private Ado ado = new Ado();

        public miseAJourProd()
        {
            InitializeComponent();
            try
            {
                ado.OuvrirConnexion();
                RemplirCombo();
                RemplirGrid();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Erreur lors de l'initialisation : " + ex.Message);
            }
        }

        public void RemplirGrid()
        {
            try
            {
                if (ado.Dataset.Tables["Produit"] != null)
                {
                    ado.Dataset.Tables["Produit"].Clear();
                }
                ado.DataAdapter = new SqlDataAdapter("select * from Produit", ado.Connection);
                ado.DataAdapter.Fill(ado.Dataset, "Produit");
                dataGridView1.DataSource = ado.Dataset.Tables["Produit"];
            }
            catch (Exception ex)
            {
                MessageBox.Show("Erreur lors du chargement des produits : " + ex.Message);
            }
        }

        public void RemplirCombo()
        {
            try
            {
                comboBox1.Items.Clear();
                if (ado.Dataset.Tables["Categorie"] != null)
                {
                    ado.Dataset.Tables["Categorie"].Clear();
                }
                ado.DataAdapter = new SqlDataAdapter("select * from Categorie", ado.Connection);
                ado.DataAdapter.Fill(ado.Dataset, "Categorie");
                comboBox1.DataSource = ado.Dataset.Tables["Categorie"];
                comboBox1.DisplayMember = "nom";
                comboBox1.ValueMember = "idCategorie";
            }
            catch (Exception ex)
            {
                MessageBox.Show("Erreur lors du chargement des catégories : " + ex.Message);
            }
        }

        private void label1_Click(object sender, EventArgs e)
        {
        }

        private void button1_Click(object sender, EventArgs e)
        {
            // Vérification des champs
            if (string.IsNullOrWhiteSpace(textBox1.Text) ||
                string.IsNullOrWhiteSpace(textBox2.Text) ||
                string.IsNullOrWhiteSpace(textBox3.Text))
            {
                MessageBox.Show("Veuillez remplir tous les champs");
                return;
            }

            // Vérifier si la catégorie est sélectionnée
            if (comboBox1.SelectedValue == null)
            {
                MessageBox.Show("Veuillez sélectionner une catégorie");
                return;
            }

            // Vérifier si le produit existe déjà
            foreach (DataRow row in ado.Dataset.Tables["Produit"].Rows)
            {
                if (textBox1.Text.Trim() == row[0].ToString().Trim())
                {
                    MessageBox.Show("Ce produit existe déjà");
                    return;
                }
            }

            try
            {
                // Ajouter le nouveau produit
                ado.Ligne = ado.Dataset.Tables["Produit"].NewRow();
                ado.Ligne[0] = textBox1.Text;
                ado.Ligne[1] = textBox2.Text;
                ado.Ligne[2] = int.Parse(textBox3.Text);
                ado.Ligne[3] = comboBox1.SelectedValue;

                ado.Dataset.Tables["Produit"].Rows.Add(ado.Ligne);

                // Mettre à jour l'affichage
                dataGridView1.DataSource = ado.Dataset.Tables["Produit"];

                MessageBox.Show("Produit ajouté avec succès !");

                // Vider les champs
                LimperChamps();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Erreur lors de l'ajout du produit : " + ex.Message);
            }
        }

        private void button2_Click(object sender, EventArgs e)
        {
            // Vérification du champ ID
            if (string.IsNullOrWhiteSpace(textBox1.Text))
            {
                MessageBox.Show("Veuillez saisir la référence du produit à supprimer");
                return;
            }

            // Déclaration d'un indicateur de trouvaille
            bool produitTrouve = false;

            // Recherche du produit à supprimer
            for (int i = 0; i < ado.Dataset.Tables["Produit"].Rows.Count; i++)
            {
                // Vérification si la référence du produit correspond à textBox1
                if (textBox1.Text.Trim() == ado.Dataset.Tables["Produit"].Rows[i][0].ToString().Trim())
                {
                    produitTrouve = true;

                    // Suppression de la ligne
                    ado.Dataset.Tables["Produit"].Rows[i].Delete();

                    MessageBox.Show("Produit supprimé avec succès");

                    // Actualisation du DataGridView
                    dataGridView1.DataSource = ado.Dataset.Tables["Produit"];

                    LimperChamps();
                    break;
                }
            }

            // Gestion du cas "produit non trouvé"
            if (produitTrouve == false)
            {
                MessageBox.Show("Aucun produit trouvé avec cette référence");
            }
        }

        private void button3_Click(object sender, EventArgs e)
        {
            // Vérification des champs obligatoires
            if (string.IsNullOrWhiteSpace(textBox1.Text) ||
                string.IsNullOrWhiteSpace(textBox2.Text) ||
                string.IsNullOrWhiteSpace(textBox3.Text))
            {
                MessageBox.Show("Veuillez remplir tous les champs");
                return;
            }

            // Vérification supplémentaire : la comboBox doit avoir une valeur sélectionnée
            if (comboBox1.SelectedValue == null)
            {
                MessageBox.Show("Veuillez sélectionner une catégorie");
                return;
            }

            // Déclaration d'un indicateur de trouvaille
            bool produitTrouve = false;

            // Recherche du produit dans le DataSet
            for (int i = 0; i < ado.Dataset.Tables["Produit"].Rows.Count; i++)
            {
                // Vérification si la référence du produit correspond à textBox1
                if (textBox1.Text.Trim() == ado.Dataset.Tables["Produit"].Rows[i][0].ToString().Trim())
                {
                    produitTrouve = true;

                    // Modification de la colonne 1 (Designation)
                    ado.Dataset.Tables["Produit"].Rows[i][1] = textBox2.Text;

                    // Modification de la colonne 2 (Quantité)
                    ado.Dataset.Tables["Produit"].Rows[i][2] = int.Parse(textBox3.Text);

                    // Modification de la colonne 3 (Catégorie)
                    ado.Dataset.Tables["Produit"].Rows[i][3] = comboBox1.SelectedValue;

                    MessageBox.Show("Produit modifié avec succès");

                    // Actualisation du DataGridView
                    dataGridView1.DataSource = ado.Dataset.Tables["Produit"];

                    LimperChamps();
                    break;
                }
            }

            // Gestion du cas "produit non trouvé"
            if (produitTrouve == false)
            {
                MessageBox.Show("Produit introuvable - Vérifiez la référence saisie");
            }
        }

        private void button4_Click(object sender, EventArgs e)
        {
            // Afficher la table des produits
            RemplirGrid();
        }

        private void button5_Click(object sender, EventArgs e)
        {
            // Enregistrer les modifications en base de données
            try
            {
                if (ado.DataAdapter == null)
                {
                    MessageBox.Show("Veuillez d'abord charger les données");
                    return;
                }

                ado.CommandeBuilder = new SqlCommandBuilder(ado.DataAdapter);
                int rowsAffected = ado.DataAdapter.Update(ado.Dataset, "Produit");

                if (rowsAffected > 0)
                {
                    MessageBox.Show($"{rowsAffected} ligne(s) enregistrée(s) avec succès !");
                }
                else
                {
                    MessageBox.Show("Aucune modification à enregistrer");
                }
                RemplirGrid();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Erreur lors de l'enregistrement : " + ex.Message);
            }
        }

        private void button6_Click(object sender, EventArgs e)
        {
            // Fermer l'application
            try
            {
                ado.FermerConnexion();
                ado.Dispose();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Erreur lors de la fermeture : " + ex.Message);
            }
            this.Close();
        }

        private void LimperChamps()
        {
            textBox1.Clear();
            textBox2.Clear();
            textBox3.Clear();
            comboBox1.SelectedIndex = -1;
        }
    }
}
